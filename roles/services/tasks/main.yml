---
- name: Find services to deploy
  tags: deploy-services
  include_vars: "{{ item }}.yml"
  with_items: "{{ services }}"

- name: Register services to deploy
  tags: deploy-services
  vars:
    reject_alias_service_regex: "^prometheus-(.*)-exporter$"
  set_fact:
    docker_services: "{{ services }}"
    alias_docker_services: "{{ services | reject('match', reject_alias_service_regex) }}"

- name: Use local config files to deploy
  tags: never, deploy-local-config
  ansible.builtin.copy:
    src: "./config/{{ item }}/{{ item }}.yml"
    dest: "{{ services_configs_path }}/{{ item }}/{{ item }}.yml"
    owner: "{{ PUID }}"
    group: "{{ PGID }}"
    force: yes
  with_items: "{{ services }}"

- name: Services configs to deploy
  tags: never, debug
  debug:
    msg: "{{ service }}"
  with_items: "{{ docker_services }}"
  vars:
    service: "{{ lookup('vars', item) | combine(container_default_opts, list_merge='keep') }}"

- name: Deploy services
  tags: deploy-services
  docker_container:
    name: "{{ service.name }}"
    image: "{{ service.image }}"
    state: started
    command_handling: correct
    recreate: "{{ service.recreate | default(false) }}"
    restart_policy: "{{ service.restart_policy }}"
    env: "{{ service.env }}"
    ports: "{{ service.ports }}"
    command: "{{ service.command }}"
    volumes: "{{ service.volumes }}"
    links: "{{ service.links }}"
    labels: "{{ service.labels }}"
  with_items: "{{ docker_services }}"
  vars:
    service: "{{ lookup('vars', item) | combine(container_default_opts, list_merge='keep') }}"
  notify:
    - clean_avahi_aliases
    - update_avahi_aliases